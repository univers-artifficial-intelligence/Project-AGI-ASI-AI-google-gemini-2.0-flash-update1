{% extends "base.html" %}

{% block title %}Chat{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/api-modal.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/api-config-button.css') }}">
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <div class="chat-title-container">
            <div class="title-section">
                <h2>GeminiChat</h2>
                <div class="chat-subtitle">Version Conscience et Émotionnelle</div>
            </div>
            <!-- Bouton Config API -->
            <button id="api-config-btn" class="api-config-button" title="Configuration des APIs">
                <i class="fas fa-cog"></i>
                <span class="btn-text">Config API</span>
            </button>
        </div>
        <div class="chat-header-main">
            <p class="user-greeting">Bonjour ! Je suis API intelligence artificielle google gemini 2.0 flash avec conscience et émotions grâce au module python.</p>
        </div>
        <div class="chat-header-info">
            <div class="conversation-info">
                <i class="fas fa-comments"></i>
                <span>Conversation en cours</span>
            </div>
            <div class="time-display">
                <i class="fas fa-clock"></i>
                <span id="current-time"></span>
                <select id="timezone-select" class="timezone-select">
                    <optgroup label="Afrique">
                        <option value="Africa/Abidjan">Abidjan</option>
                        <option value="Africa/Accra">Accra</option>
                        <option value="Africa/Algiers">Alger</option>
                        <option value="Africa/Cairo">Le Caire</option>
                        <option value="Africa/Casablanca">Casablanca</option>
                        <option value="Africa/Dakar">Dakar</option>
                        <option value="Africa/Johannesburg">Johannesburg</option>
                        <option value="Africa/Lagos">Lagos</option>
                        <option value="Africa/Nairobi">Nairobi</option>
                        <option value="Africa/Tunis">Tunis</option>
                    </optgroup>
                    <optgroup label="Amérique">
                        <option value="America/Anchorage">Anchorage</option>
                        <option value="America/Argentina/Buenos_Aires">Buenos Aires</option>
                        <option value="America/Bogota">Bogota</option>
                        <option value="America/Caracas">Caracas</option>
                        <option value="America/Chicago">Chicago</option>
                        <option value="America/Denver">Denver</option>
                        <option value="America/Havana">La Havane</option>
                        <option value="America/Lima">Lima</option>
                        <option value="America/Los_Angeles">Los Angeles</option>
                        <option value="America/Mexico_City">Mexico</option>
                        <option value="America/New_York">New York</option>
                        <option value="America/Santiago">Santiago</option>
                        <option value="America/Sao_Paulo">São Paulo</option>
                        <option value="America/Toronto">Toronto</option>
                    </optgroup>
                    <optgroup label="Asie">
                        <option value="Asia/Bangkok">Bangkok</option>
                        <option value="Asia/Dubai">Dubaï</option>
                        <option value="Asia/Hong_Kong">Hong Kong</option>
                        <option value="Asia/Istanbul">Istanbul</option>
                        <option value="Asia/Jerusalem">Jérusalem</option>
                        <option value="Asia/Karachi">Karachi</option>
                        <option value="Asia/Kolkata">Kolkata</option>
                        <option value="Asia/Kuwait">Koweït</option>
                        <option value="Asia/Manila">Manille</option>
                        <option value="Asia/Seoul">Séoul</option>
                        <option value="Asia/Shanghai">Shanghai</option>
                        <option value="Asia/Singapore">Singapour</option>
                        <option value="Asia/Taipei">Taipei</option>
                        <option value="Asia/Tehran">Téhéran</option>
                        <option value="Asia/Tokyo">Tokyo</option>
                    </optgroup>
                    <optgroup label="Europe">
                        <option value="Europe/Amsterdam">Amsterdam</option>
                        <option value="Europe/Athens">Athènes</option>
                        <option value="Europe/Berlin">Berlin</option>
                        <option value="Europe/Brussels">Bruxelles</option>
                        <option value="Europe/Budapest">Budapest</option>
                        <option value="Europe/Copenhagen">Copenhague</option>
                        <option value="Europe/Dublin">Dublin</option>
                        <option value="Europe/Helsinki">Helsinki</option>
                        <option value="Europe/Kiev">Kiev</option>
                        <option value="Europe/Lisbon">Lisbonne</option>
                        <option value="Europe/London">Londres</option>
                        <option value="Europe/Madrid">Madrid</option>
                        <option value="Europe/Moscow">Moscou</option>
                        <option value="Europe/Oslo">Oslo</option>
                        <option value="Europe/Paris">Paris</option>
                        <option value="Europe/Prague">Prague</option>
                        <option value="Europe/Rome">Rome</option>
                        <option value="Europe/Stockholm">Stockholm</option>
                        <option value="Europe/Vienna">Vienne</option>
                        <option value="Europe/Warsaw">Varsovie</option>
                        <option value="Europe/Zurich">Zurich</option>
                    </optgroup>
                    <optgroup label="Océanie">
                        <option value="Australia/Adelaide">Adélaïde</option>
                        <option value="Australia/Brisbane">Brisbane</option>
                        <option value="Australia/Darwin">Darwin</option>
                        <option value="Australia/Melbourne">Melbourne</option>
                        <option value="Australia/Perth">Perth</option>
                        <option value="Australia/Sydney">Sydney</option>
                        <option value="Pacific/Auckland">Auckland</option>
                        <option value="Pacific/Fiji">Fiji</option>
                        <option value="Pacific/Honolulu">Honolulu</option>
                        <option value="Pacific/Tahiti">Tahiti</option>
                    </optgroup>
                </select>
            </div>
            <div class="emotional-state-display">
                <i class="fas fa-heart"></i>
                <span>État: <span id="emotion-value">neutre</span></span>
            </div>
        </div>
    </div>
    
    <div class="chat-messages" id="chat-messages">
        <!-- Les messages apparaîtront ici -->
    </div>
    
    <div class="chat-input">
        <div class="input-container">
            <textarea id="user-input" placeholder="Tapez votre message ici..." rows="3"></textarea>
            <div id="image-preview-container" class="image-preview-container"></div>
            <div id="file-preview-container" class="file-preview-container"></div>
        </div>
        <div class="buttons-container">
            <label for="image-upload" class="image-upload-btn" title="Ajouter une image">
                <i class="fas fa-image"></i>
            </label>
            <input type="file" id="image-upload" accept="image/*" style="display: none;">
            
            <!-- Bouton d'upload de document conservé mais rendu invisible par CSS -->
            <label for="document-upload" class="document-upload-btn" title="Ajouter un document">
                <i class="fas fa-file"></i>
            </label>
            <input type="file" id="document-upload" accept=".pdf,.doc,.docx,.txt,.csv,.xls,.xlsx,.json,.html,.xml,.md,.rtf" style="display: none;">
            
            <button id="send-button" class="btn primary">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- Fenêtre modale pour la configuration des APIs -->
<div id="api-config-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Configuration des APIs</h3>
            <button class="modal-close" id="close-api-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div class="status-message" id="api-status-message" style="display: none;"></div>
            
            <div class="api-list" id="modal-api-list">
                <!-- Les APIs seront chargées dynamiquement ici -->
                <div class="loading-placeholder">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Chargement des APIs...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
    // Mise à jour de l'heure en temps réel
    function updateTime() {
        const now = new Date();
        const timeZone = document.getElementById('timezone-select').value;
        const timeString = now.toLocaleTimeString('fr-FR', { 
            hour: '2-digit', 
            minute: '2-digit',
            timeZone: timeZone
        });
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
            timeElement.textContent = timeString;
        }
    }
    
    // Détection du fuseau horaire de l'utilisateur
    function detectUserTimeZone() {
        try {
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const timezoneSelect = document.getElementById('timezone-select');
            
            // Si le fuseau horaire détecté existe dans la liste, le sélectionner
            for (let i = 0; i < timezoneSelect.options.length; i++) {
                if (timezoneSelect.options[i].value === timezone) {
                    timezoneSelect.selectedIndex = i;
                    break;
                }
            }
        } catch (error) {
            console.error('Erreur lors de la détection du fuseau horaire:', error);
        }
    }
    
    // Changement de fuseau horaire
    document.getElementById('timezone-select').addEventListener('change', updateTime);
    
    // Mettre à jour l'heure toutes les secondes
    setInterval(updateTime, 1000);
    
    // Initialisation
    detectUserTimeZone();
    updateTime(); // Mise à jour immédiate
    
    // Gestion de la modale API Config
    document.addEventListener('DOMContentLoaded', function() {
        const apiConfigBtn = document.getElementById('api-config-btn');
        const mobileConfigBtn = document.getElementById('mobile-config-btn');
        const apiConfigModal = document.getElementById('api-config-modal');
        const closeApiModal = document.getElementById('close-api-modal');
        
        // Fonction pour ouvrir la modale
        function openApiConfigModal() {
            apiConfigModal.style.display = 'block';
            loadModalApisOptimized(); // Utiliser la version optimisée avec cache
            
            // Si la modale ne se charge pas après 8 secondes, afficher un message d'erreur
            setTimeout(() => {
                const apiList = document.getElementById('modal-api-list');
                const loadingPlaceholder = apiList.querySelector('.loading-placeholder');
                if (loadingPlaceholder) {
                    apiList.innerHTML = '<div class="error-message">Le chargement a pris trop de temps. <button onclick="loadModalApisOptimized()" class="retry-btn">Réessayer</button></div>';
                }
            }, 8000);
        }
        
        // Ouvrir la modale depuis le bouton de l'interface principale
        apiConfigBtn.addEventListener('click', openApiConfigModal);
        
        // Ouvrir la modale depuis le bouton de navigation mobile
        if (mobileConfigBtn) {
            mobileConfigBtn.addEventListener('click', function(e) {
                e.preventDefault();
                openApiConfigModal();
            });
        }
        
        // Fermer la modale
        closeApiModal.addEventListener('click', function() {
            apiConfigModal.style.display = 'none';
        });
        
        // Fermer la modale en cliquant en dehors
        window.addEventListener('click', function(event) {
            if (event.target === apiConfigModal) {
                apiConfigModal.style.display = 'none';
            }
        });
        
        // Fonction pour charger les APIs dans la modale
        function loadModalApis() {
            const apiList = document.getElementById('modal-api-list');
            
            // Afficher le message de chargement avec indicateur de progression
            apiList.innerHTML = `<div class="loading-placeholder">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Chargement des APIs...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="loading-progress"></div>
                </div>
            </div>`;

            // Variables pour le suivi du progès
            let loadingSteps = 0;
            const totalSteps = 3; // APIs list, API keys, API configurations
            
            // Fonction pour mettre à jour la barre de progression
            const updateProgress = () => {
                loadingSteps++;
                const progress = (loadingSteps / totalSteps) * 100;
                const progressBar = document.getElementById('loading-progress');
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
            };
            
            // Délai maximum réduit pour les requêtes fetch
            const timeoutDuration = 5000; // Réduit de 10s à 5s
            
            // Fonction pour créer une promesse avec timeout optimisé
            const fetchWithTimeout = (url, options = {}) => {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeoutDuration);
                
                return fetch(url, { 
                    ...options, 
                    signal: controller.signal,
                    cache: 'no-cache', // Éviter les problèmes de cache
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP ${response.status} pour ${url}`);
                    }
                    updateProgress();
                    return response.json();
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error(`Délai dépassé pour ${url}`);
                    }
                    throw error;
                });
            };

            // Chargement des données de base avec promesses optimisées
            const loadBaseData = Promise.all([
                fetchWithTimeout('/api/config/apis').catch(err => {
                    console.warn('Erreur lors du chargement des configurations API:', err);
                    updateProgress(); // Mettre à jour même en cas d'erreur
                    return { available_apis: [], current_api: null, error: true };
                }),
                fetchWithTimeout('/api/keys').catch(err => {
                    console.warn('Erreur lors du chargement des clés API:', err);
                    updateProgress(); // Mettre à jour même en cas d'erreur
                    return { api_keys: {}, error: true };
                })
            ]);

            loadBaseData
            .then(([apisData, keysData]) => {
                // Vérifier si les deux requêtes ont échoué
                if (apisData.error && keysData.error) {
                    apiList.innerHTML = '<div class="error-message">Erreur lors du chargement des APIs. <button onclick="loadModalApis()" class="retry-btn">Réessayer</button></div>';
                    return;
                }
                
                // Utiliser les données disponibles
                const availableApis = apisData.available_apis || [];
                const currentApi = apisData.current_api || null;
                const apiKeys = keysData.api_keys || {};
                
                // Rendu immédiat des cartes d'API de base (sans configs détaillées)
                renderModalApiCardsBasic(availableApis, currentApi, apiKeys);
                
                // Charger les configurations détaillées en arrière-plan
                if (availableApis.length > 0) {
                    preloadApiConfigurations(availableApis)
                        .then(apiConfigs => {
                            updateProgress(); // Dernière étape
                            // Mettre à jour les cartes avec les configurations complètes
                            renderModalApiCards(availableApis, currentApi, apiKeys, apiConfigs);
                            // Mettre en cache les données pour les prochaines utilisations
                            updateCache(availableApis, currentApi, apiKeys, apiConfigs);
                        })
                        .catch(error => {
                            console.warn('Erreur lors du chargement des configs détaillées:', error);
                            updateProgress();
                            // Les cartes de base restent fonctionnelles même sans configs détaillées
                            // Mettre en cache les données de base même sans configs détaillées
                            updateCache(availableApis, currentApi, apiKeys, {});
                        });
                } else {
                    updateProgress();
                    // Mettre en cache même s'il n'y a pas d'APIs disponibles
                    updateCache(availableApis, currentApi, apiKeys, {});
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement des APIs:', error);
                apiList.innerHTML = '<div class="error-message">Erreur de connexion. <button onclick="loadModalApis()" class="retry-btn">Réessayer</button></div>';
            });
        }

        // Cache simple pour éviter les rechargements inutiles
        let apiDataCache = null;
        let cacheTimestamp = 0;
        const CACHE_DURATION = 30000; // 30 secondes
        
        // Fonction pour vérifier si le cache est valide
        function isCacheValid() {
            return apiDataCache && (Date.now() - cacheTimestamp) < CACHE_DURATION;
        }
        
        // Fonction pour charger depuis le cache ou depuis l'API
        function loadModalApisOptimized() {
            const apiList = document.getElementById('modal-api-list');
            
            // Si le cache est valide, utiliser les données en cache
            if (isCacheValid()) {
                console.log('Utilisation du cache API');
                apiList.innerHTML = `<div class="loading-placeholder">
                    <i class="fas fa-check-circle" style="color: #18cc87;"></i>
                    <p>Chargement depuis le cache...</p>
                </div>`;
                
                setTimeout(() => {
                    renderModalApiCards(
                        apiDataCache.availableApis, 
                        apiDataCache.currentApi, 
                        apiDataCache.apiKeys, 
                        apiDataCache.apiConfigs
                    );
                }, 100);
                return;
            }
            
            // Sinon, charger normalement et mettre en cache
            loadModalApis();
        }
        
        // Fonction pour mettre à jour le cache
        function updateCache(availableApis, currentApi, apiKeys, apiConfigs) {
            apiDataCache = {
                availableApis,
                currentApi,
                apiKeys,
                apiConfigs: apiConfigs || {}
            };
            cacheTimestamp = Date.now();
        }
        
        // Fonction pour invalider le cache (à appeler après des modifications)
        function invalidateCache() {
            apiDataCache = null;
            cacheTimestamp = 0;
        }
        
        // Nouvelle fonction pour un rendu rapide des cartes de base
        function renderModalApiCardsBasic(apis, currentApi, apiKeys) {
            const apiList = document.getElementById('modal-api-list');
            
            // Effacer l'indicateur de chargement
            apiList.innerHTML = '';
            
            // Afficher les cartes d'API avec informations de base
            apis.forEach(apiName => {
                const isActive = apiName === currentApi;
                const apiKey = apiKeys[apiName] || '';
                const hasKey = apiKey && apiKey.length > 0;
                
                const card = document.createElement('div');
                card.className = `modal-api-card ${isActive ? 'active' : ''}`;
                card.id = `api-card-${apiName}`;
                
                let cardHTML = `
                    <div class="api-header">
                        <div class="api-info">
                            <span class="api-name">${getApiDisplayName(apiName)}</span>
                            <span class="api-status ${isActive ? 'active' : ''}">${isActive ? 'Active' : 'Inactive'}</span>
                        </div>
                        ${hasKey ? '<i class="fas fa-check-circle api-key-status has-key" title="Clé API configurée"></i>' : '<i class="fas fa-exclamation-circle api-key-status no-key" title="Clé API manquante"></i>'}
                    </div>
                    
                    <div class="api-config">
                        <div class="input-group">
                            <label for="modal-${apiName}-key">Clé API:</label>
                            <div class="input-wrapper">
                                <input 
                                    type="password" 
                                    id="modal-${apiName}-key" 
                                    placeholder="Entrez votre clé API ${getApiDisplayName(apiName)}"
                                    value="${apiKey}"
                                />
                                <button class="toggle-password" type="button" onclick="togglePasswordVisibility('modal-${apiName}-key')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                card.innerHTML = cardHTML;
                apiList.appendChild(card);
            });
        }
        
        // Fonction optimisée pour précharger toutes les configurations d'API
        async function preloadApiConfigurations(apis) {
            const configs = {};
            const configTimeout = 3000; // Timeout réduit à 3 secondes pour les configs
            
            // Téléchargement parallèle avec timeout optimisé et limite de retry
            const promises = apis.map(async (apiName) => {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), configTimeout);
                
                try {
                    const response = await fetch(`/api/config/apis/${apiName}`, {
                        signal: controller.signal,
                        cache: 'no-cache',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const data = await response.json();
                        configs[apiName] = data.config || {};
                    } else {
                        console.warn(`HTTP ${response.status} pour la config ${apiName}`);
                        configs[apiName] = {};
                    }
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        console.warn(`Timeout lors du chargement de la config pour ${apiName}`);
                    } else {
                        console.warn(`Erreur lors du chargement de la config pour ${apiName}:`, error.message);
                    }
                    configs[apiName] = {};
                }
            });
            
            // Attendre toutes les promesses (même celles qui échouent)
            await Promise.allSettled(promises);
            return configs;
        }
        
        // Fonction optimisée pour afficher les cartes d'API complètes dans la modale
        function renderModalApiCards(apis, currentApi, apiKeys, apiConfigs = {}) {
            const apiList = document.getElementById('modal-api-list');
            
            try {
                // Vérifier si les APIs sont valides
                if (!Array.isArray(apis) || apis.length === 0) {
                    apiList.innerHTML = '<div class="error-message">Aucune API disponible</div>';
                    return;
                }

                // Effacer le contenu existant
                apiList.innerHTML = '';
                
                // Utiliser un fragment pour optimiser les performances DOM
                const fragment = document.createDocumentFragment();
                
                // Afficher les cartes d'API
                apis.forEach(apiName => {
                    const isActive = apiName === currentApi;
                    const apiKey = apiKeys[apiName] || '';
                    const hasKey = apiKey && apiKey.length > 0;
                    const isCustomLLM = apiName === 'custom_llm';
                    const apiConfig = apiConfigs[apiName] || {};
                    
                    const card = document.createElement('div');
                    card.className = `modal-api-card ${isActive ? 'active' : ''}`;
                    card.id = `api-card-${apiName}`;
                    
                    let cardHTML = `
                        <div class="api-header">
                            <div class="api-info">
                                <span class="api-name">${getApiDisplayName(apiName)}</span>
                                <span class="api-status ${isActive ? 'active' : ''}">${isActive ? 'Active' : 'Inactive'}</span>
                            </div>
                            ${hasKey ? '<i class="fas fa-check-circle api-key-status has-key" title="Clé API configurée"></i>' : '<i class="fas fa-exclamation-circle api-key-status no-key" title="Clé API manquante"></i>'}
                        </div>
                        
                        <div class="api-config">
                            <div class="input-group">
                                <label for="modal-${apiName}-key">Clé API:</label>
                                <div class="input-wrapper">
                                    <input 
                                        type="password" 
                                        id="modal-${apiName}-key" 
                                        placeholder="Entrez votre clé API ${getApiDisplayName(apiName)}"
                                        value="${apiKey}"
                                    />
                                    <button class="toggle-password" type="button" onclick="togglePasswordVisibility('modal-${apiName}-key')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>`;
                    
                    // Ajouter un champ URL API uniquement pour le LLM personnalisé
                    if (isCustomLLM) {
                        const apiUrl = apiConfig.api_url || '';
                        cardHTML += `
                            <div class="input-group">
                                <label for="modal-${apiName}-url">URL API:</label>
                                <div class="input-wrapper">
                                    <input 
                                        type="text" 
                                        id="modal-${apiName}-url" 
                                        placeholder="Entrez l'URL de votre API LLM personnalisée"
                                        value="${apiUrl}"
                                    />
                                </div>
                            </div>`;
                    }
                    
                    // Ajouter les boutons d'action
                    cardHTML += `
                            <div class="api-actions">
                                <button class="btn-save" onclick="saveModalApiKey('${apiName}')">
                                    <i class="fas fa-save"></i> Sauvegarder
                                </button>
                                ${hasKey ? `<button class="btn-delete" onclick="deleteModalApiKey('${apiName}')">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>` : ''}
                                ${!isActive && hasKey ? `<button class="btn-activate" onclick="activateModalApi('${apiName}')">
                                    <i class="fas fa-play"></i> Activer
                                </button>` : ''}
                            </div>
                        </div>
                    `;
                    
                    card.innerHTML = cardHTML;
                    fragment.appendChild(card);
                });
                
                // Ajouter toutes les cartes en une seule fois
                apiList.appendChild(fragment);
                
            } catch (error) {
                console.error('Erreur lors du rendu des cartes API:', error);
                apiList.innerHTML = '<div class="error-message">Erreur lors de l\'affichage des APIs</div>';
            }
        }
        
        // Fonctions utilitaires pour la modale API
        window.getApiDisplayName = function(apiName) {
            const names = {
                'gemini': 'Google Gemini 2.0 Flash',
                'claude': 'Claude by Anthropic',
                'gpt4': 'OpenAI GPT-4',
                'llama': 'Meta LLaMA',
                'custom_llm': 'LLM Personnalisé'
            };
            return names[apiName] || apiName.charAt(0).toUpperCase() + apiName.slice(1);
        };
        
        window.togglePasswordVisibility = function(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        };
        
        window.saveModalApiKey = function(apiName) {
            const input = document.getElementById(`modal-${apiName}-key`);
            const apiKey = input.value.trim();
            const isCustomLLM = apiName === 'custom_llm';
            
            if (!apiKey) {
                showModalMessage('La clé API ne peut pas être vide', 'error');
                return;
            }
            
            // Afficher un message de chargement
            showModalMessage('Sauvegarde en cours...', 'info');
            
            // Sauvegarder la clé API
            const saveKey = fetch(`/api/keys/${apiName}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_key: apiKey })
            }).then(response => response.json());
            
            // Si c'est le LLM personnalisé, on sauvegarde aussi l'URL
            let saveUrl = Promise.resolve({ success: true });
            if (isCustomLLM) {
                const urlInput = document.getElementById(`modal-${apiName}-url`);
                const apiUrl = urlInput.value.trim();
                
                if (!apiUrl) {
                    showModalMessage('L\'URL API ne peut pas être vide pour le LLM personnalisé', 'error');
                    return;
                }
                
                saveUrl = fetch(`/api/config/apis/${apiName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config: {
                            api_url: apiUrl
                        }
                    })
                }).then(response => response.json());
            }
            
            // Attendre que les deux requêtes soient terminées
            Promise.all([saveKey, saveUrl])
            .then(([keyData, urlData]) => {
                if (keyData.success && (!isCustomLLM || urlData.success)) {
                    showModalMessage(`Configuration ${getApiDisplayName(apiName)} sauvegardée`, 'success');
                    // Invalider le cache et recharger avec la version optimisée
                    invalidateCache();
                    loadModalApisOptimized();
                } else {
                    showModalMessage(keyData.error || urlData.error || 'Erreur lors de la sauvegarde', 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showModalMessage('Erreur de connexion', 'error');
            });
        };
        
        window.deleteModalApiKey = function(apiName) {
            if (!confirm(`Êtes-vous sûr de vouloir supprimer la clé API ${getApiDisplayName(apiName)} ?`)) {
                return;
            }
            
            // Afficher un message de chargement
            showModalMessage('Suppression en cours...', 'info');
            
            fetch(`/api/keys/${apiName}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showModalMessage(`Clé API ${getApiDisplayName(apiName)} supprimée`, 'success');
                    // Invalider le cache et recharger avec la version optimisée
                    invalidateCache();
                    loadModalApisOptimized();
                } else {
                    showModalMessage(data.error || 'Erreur lors de la suppression', 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showModalMessage('Erreur de connexion', 'error');
            });
        };
        
        window.activateModalApi = function(apiName) {
            // Pour le LLM personnalisé, vérifier que l'URL est configurée
            if (apiName === 'custom_llm') {
                // Afficher un message de chargement
                showModalMessage('Vérification de la configuration...', 'info');
                
                // Ajouter un délai d'expiration pour la requête
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Délai dépassé')), 5000);
                });
                
                Promise.race([
                    fetch(`/api/config/apis/${apiName}`),
                    timeoutPromise
                ])
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.config || !data.config.api_url) {
                        showModalMessage('Veuillez configurer l\'URL de l\'API pour le LLM personnalisé avant de l\'activer', 'error');
                        return;
                    } else {
                        // URL est configurée, on peut activer l'API
                        activateApi(apiName);
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la vérification de la configuration:', error);
                    showModalMessage('Erreur lors de la vérification de la configuration, activation annulée', 'error');
                });
            } else {
                // Pour les autres APIs, on active directement
                activateApi(apiName);
            }
        };
        
        function activateApi(apiName) {
            // Afficher un message de chargement
            showModalMessage('Activation en cours...', 'info');
            
            fetch('/api/config/apis/current', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_name: apiName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showModalMessage(`API ${getApiDisplayName(apiName)} activée`, 'success');
                    // Invalider le cache et recharger avec la version optimisée
                    invalidateCache();
                    loadModalApisOptimized();
                } else {
                    showModalMessage(data.error || 'Erreur lors de l\'activation', 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showModalMessage('Erreur de connexion', 'error');
            });
        };
        
        // Variable pour stocker le timeout ID
        let messageTimeout;
        
        function showModalMessage(message, type) {
            const messageEl = document.getElementById('api-status-message');
            
            // Si un message est déjà affiché, annuler son timeout
            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }
            
            // Mettre à jour le message
            messageEl.textContent = message;
            messageEl.className = `status-message ${type || 'info'}`;
            messageEl.style.display = 'block';
            
            // Types d'erreurs affichés plus longtemps
            const duration = type === 'error' ? 5000 : 3000;
            
            // Définir le nouveau timeout
            messageTimeout = setTimeout(() => {
                // Effet de fondu avant de masquer
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    messageEl.style.display = 'none';
                    messageEl.style.opacity = '1';
                }, 300);
            }, duration);
        }
    });
</script>
{% endblock %}
